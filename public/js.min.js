angular.module('bethSite', ['ui.router', 'ngCart', 'ngCookies'])

.config(function($stateProvider, $urlRouterProvider, $cookiesProvider) {

  $urlRouterProvider.otherwise('/')

  $stateProvider
    .state('home', {
      url: '/',
      templateUrl: 'views/home.html',
      controller: 'homeCtrl'
      // resolve: {
      //   user: function(authService) {
      //     return authService.getUser();
      //   }
      // }
    })

    .state('about', {
      url: '/about',
      templateUrl: 'views/about.html',
      controller: 'homeCtrl'
    })

    .state('contact', {
      url: '/contact',
      templateUrl: 'views/contact.html',
      controller: 'contactCtrl'
    })

    .state('profile', {
      url: '/user',
      templateUrl: 'views/profile.html',
      controller: 'profileCtrl',
      resolve: {
        isAuth: function ( authService ) {
        return authService.isLoggedIn();
        }
      }
    })

    .state('login', {
      url: '/login',
      templateUrl: 'directives/login.html',
      controller: 'loginCtrl'
    })

    .state('logout', {
      url: '/logout',
      controller: 'logoutCtrl',
    })

    .state('signup', {
      url: '/signup',
      templateUrl: 'directives/signup.html',
      controller: 'signupCtrl'
    })

    .state('cart', {
      url:  '/cart',
      templateUrl: 'views/cart.html',
      controller: 'cartCtrl',
      resolve: {
        isAuth: function ( authService ) {
        return authService.isLoggedIn();
        }
      }
    })

})

// .run(['$state', '$cookies', '$rootScope', function($state, $cookies, $rootScope) {
//     $rootScope.$on('$stateChangeStart', function(e, toState, toParams, fromState, fromParams) {
//
//         if (toState.name.indexOf('profile') > -1 && !$cookies.Session) {
//             // If logged out and transitioning to a logged in page:
//             e.preventDefault();
//             $state.go('login');
//         } else if (toState.name.indexOf('cart') > -1 && $cookies.Session) {
//             e.preventDefault();
//             $state.go('home');
//         };
//     });
// }]);

// .run(function($rootScope, $location, $state, authService) {
//   $rootScope.$on('$stateChangeStart',
//     function (event, next, current) {
//       authService.getUserStatus();
//       if(next.access.restricted &&
//         !authService.isLoggedIn()) {
//         $location.path('/login');
//         $state.reload();
//       }
//     })
// })

angular.module('bethSite')
.directive('dirViewer', function() {

  return {
    restrict: 'E',
    templateUrl: 'directives/viewer.html',
    controller: 'viewDirCtrl'

  }

})




angular.module('bethSite')
.service('cartSvc', function() {
  var hello = "hello"
})

angular.module('bethSite')
.service('homeSvc', function() {

  var pics = [
  {
    name: 'Angel',
    imgUrl: 'angel.jpg',
    fullPic: 'Angel-min.jpg',
    options: [
              {id: '5', size:'3x3 - $2.00' , price: {amount: '1.00', print: 'doesnt matter'}},
              {id: '1', size:'4x6 - $5.00' , price: {amount: '5.00', print:'4x6'}},
              {id: '2', size:'5x7 - $15.00', price: {amount: '15.00', print:'5x7'}},
              {id: '3', size:'8x10 - $25.00', price: {amount: '25.00', print:'8x10'}},
              {id: '4', size:'16x20 - $60.00', price: {amount: '60.00', print:'16x20'}}
            ],
  },
  {
    name: 'Bird',
    imgUrl: 'birds.jpg',
    fullPic: 'Birdsi.jpg',
    options: [
              {id: '1', size:'4x6 - $5.00', price: {amount: '5.00', print:'4x6'}},
              {id: '2', size:'5x7 - $15.00', price: {amount: '15.00', print:'5x7'}},
              {id: '3', size:'8x10 - $25.00', price: {amount: '25.00', print:'8x10'}},
              {id: '4', size:'16x20 - $60.00', price: {amount: '60.00', print:'16x20'}}
            ],
  },
  {
    name: 'Blue Dragon',
    imgUrl: 'blue_dragon.jpg',
    fullPic: 'BlueDragon-min.jpg',
    options: [
              {id: '1', size: 'pending'}
    ]
  },
  {
    name: 'Butterfly',
    imgUrl: 'butterfly.jpg',
    fullPic: 'Butterfly-min.jpg',
    options: [
              {id: '1', size:'4x6 - $5.00', price: {amount: '5.00', print:'4x6'}},
              {id: '2', size:'5x7 - $15.00', price: {amount: '15.00', print:'5x7'}},
              {id: '3', size:'8x10 - $25.00', price: {amount: '25.00', print:'8x10'}},
              {id: '4', size:'16x20 - $60.00', price: {amount: '60.00', print:'16x20'}}
            ],
    selectedOption: {id: '3', size: '8x10 25.00'}
  },
  {
    name: 'Dance of the Cauldron',
    imgUrl: 'cauldron.jpg',
    fullPic: 'Cauldron-min.jpg',
    options: [
              {id: '1', size:'4x6 - $5.00', price: {amount: '5.00', print:'4x6'}},
              {id: '2', size:'5x7 - $15.00', price: {amount: '15.00', print:'5x7'}},
              {id: '3', size:'8x10 - $25.00', price: {amount: '25.00', print:'8x10'}},
              {id: '4', size:'16x20 - $60.00', price: {amount: '60.00', print:'16x20'}}
            ],
  },
  {
    name: 'The Dress',
    imgUrl: 'dress.jpg',
    fullPic: 'Dress-min.jpg',
    options: [
              {id: '1', size:'4x6 - $5.00', price: {amount: '5.00', print:'4x6'}},
              {id: '2', size:'5x7 - $15.00', price: {amount: '15.00', print:'5x7'}},
              {id: '3', size:'8x10 - $25.00', price: {amount: '25.00', print:'8x10'}},
              {id: '4', size:'16x20 - $60.00', price: {amount: '60.00', print:'16x20'}}
            ],
  },
  {
    name: 'Green Dragon',
    imgUrl: 'green_dragon.jpg',
    fullPic: 'Dragon1-min.jpg',
    options: [
              {id: '1', size:'4x6 - $5.00', price: {amount: '5.00', print:'4x6'}},
              {id: '2', size:'5x7 - $15.00', price: {amount: '15.00', print:'5x7'}},
              {id: '3', size:'8x10 - $25.00', price: {amount: '25.00', print:'8x10'}},
              {id: '4', size:'16x20 - $60.00', price: {amount: '60.00', print:'16x20'}}
            ],
  },
  {
    name: 'Mermaid',
    imgUrl: 'mermaid.jpg',
    fullPic: 'Mermaid-min.jpg',
    options: [
              {id: '1', size:'4x6 - $5.00', price: {amount: '5.00', print:'4x6'}},
              {id: '2', size:'5x7 - $15.00', price: {amount: '15.00', print:'5x7'}},
              {id: '3', size:'8x10 - $25.00', price: {amount: '25.00', print:'8x10'}},
              {id: '4', size:'16x20 - $60.00', price: {amount: '60.00', print:'16x20'}}
            ],
  },
  {
    name: 'Miracles',
    imgUrl: 'miracles.jpg',
    fullPic: 'miracles-min.jpg',
    options: [
            {id: '0', size: null, price: null},
            {id: '1', size: 'pending'}
    ]
  },
  {
    name: 'The Fool',
    imgUrl: 'one-with-nature.jpg',
    fullPic: 'The_Fool-min.jpg',
    options: [
              {id: '1', size:'4x6 - $5.00', price: {amount: '5.00', print:'4x6'}},
              {id: '2', size:'5x7 - $15.00', price: {amount: '15.00', print:'5x7'}},
              {id: '3', size:'8x10 - $25.00', price: {amount: '25.00', print:'8x10'}},
              {id: '4', size:'16x20 - $60.00', price: {amount: '60.00', print:'16x20'}}
            ],
  },
  {
    name: 'Owls',
    imgUrl: 'owls.jpg',
    fullPic: 'Owls-min.jpg',
    options: [
              {id: '1', size:'4x6 - $5.00', price: {amount: '5.00', print:'4x6'}},
              {id: '2', size:'5x7 - $15.00', price: {amount: '15.00', print:'5x7'}},
              {id: '3', size:'8x10 - $25.00', price: {amount: '25.00', print:'8x10'}},
              {id: '4', size:'16x20 - $60.00', price: {amount: '60.00', print:'16x20'}}
            ],
  },
  {
    name: 'Rainbow',
    imgUrl: 'rainbow2.jpg',
    fullPic: 'Rainbow2-min.jpg',
    options: [
              {id: '1', size:'4x6 - $5.00', price: {amount: '5.00', print:'4x6'}},
              {id: '2', size:'5x7 - $15.00', price: {amount: '15.00', print:'5x7'}},
              {id: '3', size:'8x10 - $25.00', price: {amount: '25.00', print:'8x10'}},
              {id: '4', size:'16x20 - $60.00', price: {amount: '60.00', print:'16x20'}}
            ],
  },
  {
    name: 'Red Dragon',
    imgUrl: 'red_dragon.jpg',
    fullPic: 'Red_Dragon-min.jpg',
    options: [
              {id: '1', size:'4x6 - $5.00', price: {amount: '5.00', print:'4x6'}},
              {id: '2', size:'5x7 - $15.00', price: {amount: '15.00', print:'5x7'}},
              {id: '3', size:'8x10 - $25.00', price: {amount: '25.00', print:'8x10'}},
              {id: '4', size:'16x20 - $60.00', price: {amount: '60.00', print:'16x20'}}
            ],
  },
  {
    name: 'Koi',
    imgUrl: 'red_fish.jpg',
    fullPic: 'Koi-min.jpg',
    options: [
              {id: '1', size:'4x6 - $5.00', price: {amount: '5.00', print:'4x6'}},
              {id: '2', size:'5x7 - $15.00', price: {amount: '15.00', print:'5x7'}},
              {id: '3', size:'8x10 - $25.00', price: {amount: '25.00', print:'8x10'}},
              {id: '4', size:'16x20 - $60.00', price: {amount: '60.00', print:'16x20'}}
            ],
  },
  {
    name: 'Poppies',
    imgUrl: 'red_flowers.jpg',
    fullPic: 'Poppies-min.jpg',
    options: [
              {id: '1', size:'4x6 - $5.00', price: {amount: '5.00', print:'4x6'}},
              {id: '2', size:'5x7 - $15.00', price: {amount: '15.00', print:'5x7'}},
              {id: '3', size:'8x10 - $25.00', price: {amount: '25.00', print:'8x10'}},
              {id: '4', size:'16x20 - $60.00', price: {amount: '60.00', print:'16x20'}}
            ],
  },
  {
    name: 'Vines',
    imgUrl: 'tree_fairy.jpg',
    fullPic: 'Vines-min.jpg',
    options: [
              {id: '1', size:'4x6 - $5.00', price: {amount: '5.00', print:'4x6'}},
              {id: '2', size:'5x7 - $15.00', price: {amount: '15.00', print:'5x7'}},
              {id: '3', size:'8x10 - $25.00', price: {amount: '25.00', print:'8x10'}},
              {id: '4', size:'16x20 - $60.00', price: {amount: '60.00', print:'16x20'}}
            ],
  }
]

  this.getPic = function() {
    return pics;
  }

  this.info = [

  ]


})

angular.module('bethSite')
.factory('authService', function($q, $timeout, $http) {

  var user = null;

  var userInfo = 'stuff';

  return ({
    isLoggedIn: isLoggedIn,
    getUserStatus: getUserStatus,
    getUser: getUser,
    login: login,
    logout: logout,
    register: register,
    makeOrder: makeOrder
  });



  function isLoggedIn() {
    console.log(user + ' from service');
    if(user) {
      return true;
    } else {
      return false;
    }
  };

  function getUser() {
    console.log(userInfo + ' from service');
    if(user) {
      return userInfo;
    } else {
      return false;
    }
  }


  function getUserStatus() {
    $http.get('/user/status')
    // handle success
    .success(function (data) {
      if(data){
        user = true;
      } else {
        user = false;
      }
      return user;
    })
    // handle error
    .error(function (data) {
      user = false;
    });
  }



  function login(username, password) {
    var deferred = $q.defer();
    $http.post('/user/login',
      {username: username, password: password})
      //handle success
      .success(function (data, status) {

        if(status === 200 && data) {
          user = true;
          console.log(userInfo)
          userInfo = data
          console.log(userInfo + " from userInfo")

          deferred.resolve();
        } else {
          user = false;
          deferred.reject();
        }
      })
      //handle error
      .error(function(data) {
        user = false;
        deferred.reject();
      });
      //return promise object
      return deferred.promise;
  }

  function makeOrder(userInfo, product) {
    var deferred = $q.defer();

    var items = function() {
      for(var i = 0; i < product.length; i++) {

      }
    }
    ////!!!!STILL BROKEN  NEED HELP!!!!/////

    $http.post('/api/order/' ,
      { user: userInfo,
        products:
          function() {
            var list = [];
            for(var i = 0; i < product.length; i++) {
              list.push({ name : product[i]._name,
                          quantity: product[i]._quantity
                        })
            }
            return list
          }()
      })
      //handle success
      .success(function(data, status) {
        if(status === 200 && data) {
          deferred.resolve();
        } else {
          deferred.reject();
        }
      })
      //handle error
      .error(function (data) {
        deferred.reject();
      });
      return deferred.promise;
  }



  function logout() {
    //create a new instance of deferred
    var deferred = $q.defer();

    //send a get request to the server
    $http.get('/user/logout')
    //handle success
    .success(function (data) {
      user = false;
      deferred.resolve();
    })
    //handle error
    .error(function (data){
      user = false;
      deferred.reject();
    });
    //return promise object
    return deferred.promise;
  }


  function register(username, password, firstName, lastName, email, number, street, city, state, zip) {
    //create a new instance of deferred
    var deferred = $q.defer();

    //send a post request to the server
    $http.post('/user/register',
      { username: username,
        password: password,
        name: {
          firstName: firstName,
          lastName: lastName
        },
        email: email,
        number: number,
        address: {
          street: street,
          city: city,
          state: state,
          zip: zip
        }
      })
      //handle success
      .success(function(data, status) {
        if(status === 200 && data) {
          deferred.resolve();
        } else {
          deferred.reject();
        }
      })
      //handle error
      .error(function (data) {
        deferred.reject();
      });
      return deferred.promise;
  }
});


angular.module('bethSite')
.controller('loginCtrl', function($scope, $location, authService) {



  $scope.login = function () {
    //initial values
    $scope.error = false;
    $scope.disabled = true;
    //call login from service
    authService.login($scope.loginForm.username, $scope.loginForm.password)
    //handle success
    .then (function () {
      $location.path('/');
      $scope.disabled = false;
      $scope.loginForm = {};
    })
    //handle error
    .catch(function() {
      $scope.error = true;
      $scope.errorMessage = "Invalid username and/or password";
      $scope.disabled = false;
      $scope.loginForm = {};
    })
  }
})

.controller('logoutCtrl', function($scope, $location, authService) {

  $scope.logout = function () {
    //call logout from service
    authService.logout()
      .then(function() {
        $location.path('/login');
      })
  }
})

.controller('signupCtrl', function($scope, $location, authService) {

  $scope.register = function() {
    //initial values
    $scope.error = false;
    $scope.disabled = true;

    //call signup from service
    authService.register(
      $scope.registerForm.username,
      $scope.registerForm.password,
      $scope.registerForm.firstName,
      $scope.registerForm.lastName,
      $scope.registerForm.email,
      $scope.registerForm.number,
      $scope.registerForm.street,
      $scope.registerForm.city,
      $scope.registerForm.state,
      $scope.registerForm.zip
    )
    //handle success
    .then(function () {
      $location.path('/login');
      $scope.disabled = false;
      $scope.registerForm = {};
    })
    //handle error
    .then(function () {
      $scope.error = true;
      $scope.errorMessage = "Something went wrong!";
      $scope.disabled = false;
      $scope.registerForm = {};
    })
  }
})


angular.module('bethSite')
.controller('profileCtrl', function($scope, authService, $state, isAuth) {

	if(isAuth === false) {
		$state.go('login')
	}


	$scope.isUser = authService.isLoggedIn();
  console.log($scope.isUser + 'From Controller')


	$scope.user = authService.getUser();
	console.log($scope.user + ' from controller')


})

angular.module('bethSite')
.controller('viewDirCtrl', function($scope, $sce, authService) {


  var modal = document.getElementById('myModal');

  // var img = document.getElementById('myImg');
  var modalImg = document.getElementById('img01');
  // var modalVid = document.getElementById('vid01');


  $scope.expand = function() {
    modal.style.display = 'block';
    modalImg.style.display = 'block';
    modalImg.src = '../images/' + this.img.fullPic;
  }

  $scope.closeClick = function() {
    modal.style.display = 'none';
    modalImg.style.display = 'none';
  }
})

angular.module('bethSite')
.controller('cartCtrl', function($scope, $http, ngCart, homeSvc, authService, isAuth, $state, ngCart) {

  ngCart.setShipping(5.00)

  if(isAuth === false) {
    $state.go('login')
  }

  $scope.userInfo = authService.getUser()

  $scope.isUser = authService.isLoggedIn();
  console.log($scope.isUser + 'From Controller')

  $scope.inNgCart = ngCart

  $scope.getCart = ngCart.getCart().items

  $scope.makeOrder = function () {
    authService.makeOrder($scope.userInfo, $scope.getCart)
  }

})

angular.module('bethSite')
.controller('contactCtrl', function($scope, authService) {

  $scope.sendFrickenMessage = function(data) {
    $.ajax({
        url: "https://formspree.io/josephlago90@gmail.com",
        method: "POST",
        data: {
          name: data.name,
          email: data.email,
          subject: data.subject,
          message: data.message,
        } ,
        dataType: "json"
    });
    alert('Thanks for the e-mail!');
    return false;
  }

  $scope.isUser = authService.isLoggedIn();
  console.log($scope.isUser + 'From Controller')

})

angular.module('bethSite')
.controller('homeCtrl', function($scope, homeSvc, authService) {

  $scope.home = {name: 'Welcome to Dream B'};

  $scope.image = homeSvc.getPic();

  $scope.isUser = authService.isLoggedIn();
  console.log($scope.isUser + 'From Controller')

  // $scope.addCart = function(){
  //   if(!anything || !model.id && !user) {
  //     console.log("Please log in and select size/number desired.");
  //   } else if (!user) {
  //     //link to log in page
  //   } else {
  //     var order = {
  //       product: 'this.imgUrl',
  //       //size: '',
  //       //price: '',
  //       //number requested: ''
  //     }
  //     cartSvc.cart.push(order);
  //   }
  // }

})
